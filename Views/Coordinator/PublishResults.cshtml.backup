@{
    ViewData["Title"] = "Publish Results - " + Model.Exam.Title;
}

<div class="row">
    <div class="col-12">
        <h2>Publish Exam Results</h2>
        <p class="text-muted">Exam: @Model.Exam.Title</p>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5>Results Summary</h5>
                    <div class="btn-group">
                        <a asp-action="GenerateResults" asp-controller="Result" asp-route-examId="@Model.Exam.Id" 
                           class="btn btn-primary" onclick="return confirm('Generate results for this exam?')">
                            <i class="bi bi-calculator"></i> Generate Results
                        </a>
                        <button class="btn btn-success" onclick="publishAllResults()">
                            <i class="bi bi-check-circle"></i> Publish All
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                @if (!Model.Results.Any())
                {
                    <div class="alert alert-warning text-center">
                        <h4>No Results Generated Yet</h4>
                        <p>Generate results before publishing them to students.</p>
                        <a asp-action="GenerateResults" asp-controller="Result" asp-route-examId="@Model.Exam.Id" 
                           class="btn btn-primary">
                            <i class="bi bi-calculator"></i> Generate Results Now
                        </a>
                    </div>
                }
                else
                {
                    <div class="results-summary mb-4">
                        <div class="row text-center">
                            <div class="col-md-2">
                                <h4 class="text-primary">@Model.Results.Count</h4>
                                <small class="text-muted">Total Results</small>
                            </div>
                            <div class="col-md-2">
                                <h4 class="text-success">@Model.Results.Count(x => x.Percentage >= 70)</h4>
                                <small class="text-muted">Passed (â‰¥70%)</small>
                            </div>
                            <div class="col-md-2">
                                <h4 class="text-danger">@Model.Results.Count(x => x.Percentage < 70)</h4>
                                <small class="text-muted">Failed (<70%)</small>
                            </div>
                            <div class="col-md-2">
                                <h4 class="text-info">@Model.Results.Average(x => x.Percentage).ToString("0.0")%</h4>
                                <small class="text-muted">Average Score</small>
                            </div>
                            <div class="col-md-2">
                                <h4 class="text-warning">@Model.Results.Max(x => x.Percentage).ToString("0.0")%</h4>
                                <small class="text-muted">Highest Score</small>
                            </div>
                            <div class="col-md-2">
                                <h4 class="text-secondary">@Model.Results.Min(x => x.Percentage).ToString("0.0")%</h4>
                                <small class="text-muted">Lowest Score</small>
                            </div>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>
                                        <input type="checkbox" id="selectAll" onchange="toggleAllResults()">
                                    </th>
                                    <th>Student</th>
                                    <th>Student ID</th>
                                    <th>Score</th>
                                    <th>Percentage</th>
                                    <th>Grade</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var result in Model.Results.OrderByDescending(x => x.Percentage))
                                {
                                    <tr>
                                        <td>
                                            <input type="checkbox" class="result-checkbox" value="@result.Id" 
                                                   @(result.IsPublished ? "checked" : "") onchange="updatePublishStatus(@result.Id)">
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2">
                                                    @(result.ExamAttempt.Student?.FirstName?.FirstOrDefault().ToString().ToUpper() ?? "S")
                                                </div>
                                                <div>
                                                    <div class="fw-bold">@result.ExamAttempt.Student?.FirstName @result.ExamAttempt.Student?.LastName</div>
                                                    <small class="text-muted">@result.ExamAttempt.Student?.Email</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td><code>@result.ExamAttempt.Student?.StudentNumber</code></td>
                                        <td>
                                            <span class="fw-bold">@result.Score/@result.TotalPoints</span>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="progress me-2" style="width: 60px; height: 20px;">
                                                    <div class="progress-bar @(result.Percentage >= 70 ? "bg-success" : result.Percentage >= 50 ? "bg-warning" : "bg-danger")" 
                                                         style="width: @result.Percentage%">
                                                    </div>
                                                </div>
                                                <span>@result.Percentage.ToString("0.0")%</span>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge bg-@(result.Grade switch
                                            {
                                                "A" => "success",
                                                "B" => "info",
                                                "C" => "primary",
                                                "D" => "warning",
                                                _ => "danger"
                                            })">@result.Grade</span>
                                        </td>
                                        <td>
                                            @if (result.IsPublished)
                                            {
                                                <span class="badge bg-success">Published</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary">Draft</span>
                                            }
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <a asp-action="Details" asp-controller="Result" asp-route-id="@result.Id" 
                                                   class="btn btn-outline-primary">
                                                    <i class="bi bi-eye"></i>
                                                </a>
                                                <button class="btn btn-outline-info" onclick="addFeedback(@result.Id)">
                                                    <i class="bi bi-chat-quote"></i>
                                                </button>
                                                <button class="btn btn-outline-success" onclick="notifyStudent(@result.Id)">
                                                    <i class="bi bi-envelope"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@if (Model.Results.Any())
{
    <div class="row mt-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5>Grade Distribution</h5>
                </div>
                <div class="card-body">
                    <canvas id="gradeChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5>Publishing Options</h5>
                </div>
                <div class="card-body">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="notifyStudents" checked>
                        <label class="form-check-label" for="notifyStudents">
                            Notify students via email
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="allowReview" checked>
                        <label class="form-check-label" for="allowReview">
                            Allow students to review answers
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="showRankings">
                        <label class="form-check-label" for="showRankings">
                            Show class rankings
                        </label>
                    </div>
                    
                    <hr>
                    
                    <div class="d-grid gap-2">
                        <button class="btn btn-success" onclick="publishSelected()">
                            <i class="bi bi-check-circle"></i> Publish Selected
                        </button>
                        <button class="btn btn-warning" onclick="unpublishSelected()">
                            <i class="bi bi-x-circle"></i> Unpublish Selected
                        </button>
                        <a asp-action="ExportResults" asp-controller="Result" asp-route-examId="@Model.Exam.Id" 
                           class="btn btn-outline-info">
                            <i class="bi bi-download"></i> Export Results
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<!-- Feedback Modal -->
<div class="modal fade" id="feedbackModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Student Feedback</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="feedbackForm">
                    <input type="hidden" id="feedbackResultId" />
                    <div class="mb-3">
                        <label for="feedbackText" class="form-label">Feedback Comments</label>
                        <textarea class="form-control" id="feedbackText" rows="4" 
                                  placeholder="Provide constructive feedback for the student..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="feedbackType" class="form-label">Feedback Type</label>
                        <select class="form-select" id="feedbackType">
                            <option value="encouragement">Encouragement</option>
                            <option value="improvement">Areas for Improvement</option>
                            <option value="excellent">Excellent Performance</option>
                            <option value="general">General Comments</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveFeedback()">Save Feedback</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        function toggleAllResults() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.result-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
                updatePublishStatus(checkbox.value);
            });
        }
        
        function updatePublishStatus(resultId) {
            const checkbox = document.querySelector(`[value="${resultId}"]`);
            const isPublished = checkbox.checked;
            
            // AJAX call to update publish status
            fetch(`/Result/UpdatePublishStatus/${resultId}?publish=${isPublished}`, {
                method: 'POST'
            }).then(response => {
                if (response.ok) {
                    console.log('Publish status updated');
                }
            });
        }
        
        function publishAllResults() {
            if (confirm('Publish all results to students?')) {
                document.querySelectorAll('.result-checkbox').forEach(checkbox => {
                    checkbox.checked = true;
                    updatePublishStatus(checkbox.value);
                });
                alert('All results published successfully!');
            }
        }
        
        function publishSelected() {
            const selected = document.querySelectorAll('.result-checkbox:checked');
            if (selected.length === 0) {
                alert('Please select results to publish');
                return;
            }
            
            selected.forEach(checkbox => {
                updatePublishStatus(checkbox.value);
            });
            alert(`Published ${selected.length} results successfully!`);
        }
        
        function unpublishSelected() {
            const selected = document.querySelectorAll('.result-checkbox:checked');
            if (selected.length === 0) {
                alert('Please select results to unpublish');
                return;
            }
            
            selected.forEach(checkbox => {
                checkbox.checked = false;
                updatePublishStatus(checkbox.value);
            });
            alert(`Unpublished ${selected.length} results successfully!`);
        }
        
        function addFeedback(resultId) {
            document.getElementById('feedbackResultId').value = resultId;
            const modal = new bootstrap.Modal(document.getElementById('feedbackModal'));
            modal.show();
        }
        
        function saveFeedback() {
            const resultId = document.getElementById('feedbackResultId').value;
            const feedbackText = document.getElementById('feedbackText').value;
            const feedbackType = document.getElementById('feedbackType').value;
            
            // AJAX call to save feedback
            fetch(`/Result/AddFeedback/${resultId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    text: feedbackText,
                    type: feedbackType
                })
            }).then(response => {
                if (response.ok) {
                    alert('Feedback saved successfully!');
                    bootstrap.Modal.getInstance(document.getElementById('feedbackModal')).hide();
                }
            });
        }
        
        function notifyStudent(resultId) {
            if (confirm('Send result notification to student?')) {
                alert('Notification sent to student!');
            }
        }
        
        // Grade distribution chart
        @if (Model.Results.Any())
        {
            <text>
            const ctx = document.getElementById('gradeChart').getContext('2d');
            const gradeData = {
                'A': @Model.Results.Count(x => x.Grade == "A"),
                'B': @Model.Results.Count(x => x.Grade == "B"),
                'C': @Model.Results.Count(x => x.Grade == "C"),
                'D': @Model.Results.Count(x => x.Grade == "D"),
                'F': @Model.Results.Count(x => x.Grade == "F")
            };
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(gradeData),
                    datasets: [{
                        label: 'Number of Students',
                        data: Object.values(gradeData),
                        backgroundColor: ['#28a745', '#17a2b8', '#007bff', '#ffc107', '#dc3545']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
            </text>
        }
    </script>
}
